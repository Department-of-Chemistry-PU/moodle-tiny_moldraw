<!doctype html>
<html lang="en">
  <head>
    <script defer="defer" src="./static/js/main.963f80c2.js"></script>
    <link href="./static/css/main.3fc9c0f8.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
  <noscript>You need to enable JavaScript to run this app.</noscript>
  <div class="center">
    <div id="root"></div>
<p>
  <label for="width">Width:</label>
  <input type="text" id="width" name="width" value="100">
</p>
<p>
  <label for="height">Height:</label>
  <input type="text" id="height" name="height" value="100">
</p>
    <p><button class="sketchsubmit" onclick="exportMOLfile();">Export Molecule in Molfile</button></p>
	<p id="output">output:</p>
  </div>
<script>
  var ketcher = null;

  function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }
  function outputImage() {
	var output = document.getElementById("output");
    ketcher.getKet().then(struct => ketcher.generateImage(struct, {
      outputFormat: "svg",
      backgroundColor: "255, 255, 255"
    })).then(blob => blobToBase64(blob)).then(base64 => {
      var img = document.createElement('img');
      img.src = base64;
      output.innerHTML = '';
	output.appendChild(img);
    }).catch(error => window.alert(error));
  }

  ///export to parent tinymce textarea as image the ketcher xml format
function exportMOLfile() {
outputImage();
var width = document.getElementById('width');
var height = document.getElementById('height');
    getData().then(({ dataURI, ketData }) => {
      console.log('dataURI:', dataURI);  // Print dataURI to the console
      console.log('ketData:', ketData);  // Print ketData to the console
      window.parent.tinyMCE.activeEditor.execCommand('mceInsertContent', 0, '<img src="'+dataURI+'" width="'+width.value+'px" height="'+height.value+'px">');
      window.parent.tinyMCE.activeEditor.execCommand('mceInsertContent', 0, '<!--[ketdata]'+ketData+'[/ketData]');
      $(window.parent.document).find(".modal").find('.close').click();
    }).catch(error => {
      console.error(error);
      alert(error);
    });
  }
    // Expose the dataURI and ketData to the parent window
  function getData() {
  return new Promise((resolve, reject) => {
    ketcher.getKet().then(struct => {
      ketcher.generateImage(struct, {
        outputFormat: "svg",
        backgroundColor: "255, 255, 255",
      }).then(blob => blobToBase64(blob)).then(base64 => {
        resolve({
          dataURI: base64,
          ketData: struct,
        });
      }).catch(reject);
    }).catch(reject);
  });
}
// Make the function accessible from the parent window
  window.getData = getData;
</script>
</body>
</html>
